<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arixo Messenger Pro | Official Full System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* --- CSS ต้นฉบับจาก index.html (ครบ 100%) --- */
        :root {
            --bg: #e0f7f1; --bg-gradient: radial-gradient(circle at center, #f0fffb, #b2f2e3);
            --card: #ffffff; --primary: #18e0c4; --primary-grad: linear-gradient(135deg, #18e0c4, #0d9488);
            --text: #1c1e21; --muted: #65676b; --bubble-me: #18e0c4; --bubble-you: #e6ffad; --accent: #ff4757;
        }
        body.dark-mode { --bg: #0b1220; --card: #0f1c26; --text: #f5f6f7; --muted: #90949c; --bubble-me: #0d9488; --bubble-you: #242f3d; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        #app { width: 100%; max-width: 500px; height: 100%; background: var(--card); display: flex; flex-direction: column; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

        /* --- UI ส่วนระบบสมาชิก --- */
        #auth-screen { position: absolute; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .auth-box { width: 100%; max-width: 320px; text-align: center; }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; box-sizing: border-box; }
        .auth-btn { width: 100%; padding: 15px; background: var(--primary-grad); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* --- UI ส่วน Header & Friend List --- */
        .chat-header { padding: 15px; background: var(--primary-grad); color: white; display: flex; align-items: center; gap: 10px; z-index: 100; }
        #friend-list { display: flex; gap: 15px; padding: 12px; background: rgba(0,0,0,0.03); border-bottom: 1px solid #ddd; overflow-x: auto; }
        .friend-card { min-width: 60px; text-align: center; cursor: pointer; }
        .friend-card i { font-size: 35px; color: var(--primary); }

        /* --- UI ส่วนข้อความ --- */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: var(--bg-gradient); }
        .msg { max-width: 75%; padding: 10px 15px; border-radius: 20px; font-size: 14px; position: relative; animation: pop 0.3s ease; cursor: pointer; }
        .msg.me { align-self: flex-end; background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
        .msg.you { align-self: flex-start; background: var(--bubble-you); color: #333; border-bottom-left-radius: 4px; }

        /* --- Overlay อื่นๆ --- */
        #callOverlay { position: fixed; inset:0; background:var(--primary-grad); z-index:1100; display:none; flex-direction:column; align-items:center; justify-content:center; color:white; }
        #replyBar { display: none; padding: 10px; background: #eee; border-left: 5px solid var(--primary); font-size: 12px; }

        .footer { padding: 12px; background: var(--card); display: flex; align-items: center; gap: 8px; border-top: 1px solid #eee; }
        #mainInput { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; outline: none; }
        
        @keyframes pop { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div id="app">
    <div id="auth-screen">
        <div class="auth-box">
            <h1 style="color:var(--primary)">Arixo Messenger</h1>
            <input type="email" id="auth-email" class="auth-input" placeholder="อีเมล">
            <input type="password" id="auth-pass" class="auth-input" placeholder="รหัสผ่าน (6 ตัวขึ้นไป)">
            <button onclick="handleAuth()" class="auth-btn">เข้าสู่ระบบ / สมัครสมาชิก</button>
            <p id="auth-error" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="callOverlay">
        <h2 id="callType">Voice Call</h2>
        <div class="fa fa-user-circle fa-5x" style="margin: 30px 0;"></div>
        <button onclick="closeCall()" style="background:#ff4757; border:none; color:white; padding:15px 30px; border-radius:30px; cursor:pointer;"><i class="fa fa-phone-slash"></i> วางสาย</button>
    </div>

    <div class="chat-header">
        <div style="flex:1">
            <div id="target-name" style="font-weight:bold">Arixo Messenger</div>
            <div id="my-id-display" style="font-size:10px; opacity:0.8">ID: ------</div>
        </div>
        <i class="fa fa-moon" onclick="document.body.classList.toggle('dark-mode')" style="cursor:pointer"></i>
        <i class="fa fa-video" onclick="openCall('Video Call')" style="margin-left:15px; cursor:pointer"></i>
        <i class="fa fa-phone" onclick="openCall('Voice Call')" style="margin-left:15px; cursor:pointer"></i>
        <i class="fa fa-sign-out-alt" onclick="auth.signOut()" style="margin-left:15px; cursor:pointer"></i>
    </div>

    <div id="friend-list"></div>

    <div id="replyBar">
        <span id="replyText"></span>
        <i class="fa fa-times" onclick="cancelReply()" style="float:right; cursor:pointer"></i>
    </div>

    <div id="chat-container">
        <div style="text-align:center; color:#888; margin-top:50px;">เลือกเพื่อนด้านบนเพื่อเริ่มแชทส่วนตัว</div>
    </div>

    <div class="footer">
        <i class="fa fa-plus-circle" style="color:var(--primary); font-size:20px; cursor:pointer"></i>
        <input type="text" id="mainInput" placeholder="พิมพ์ข้อความ..." onkeypress="if(event.key==='Enter') sendMsg()">
        <button onclick="sendMsg()" style="background:var(--primary-grad); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer;">
            <i class="fa fa-paper-plane"></i>
        </button>
    </div>
</div>

<script>
    // --- 1. Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyACTSU6LYObSv5gEAfKJt4Yr4LaCCAkQvw",
        authDomain: "goldorax-game.firebaseapp.com",
        databaseURL: "https://goldorax-game-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "goldorax-game",
        storageBucket: "goldorax-game.firebasestorage.app",
        messagingSenderId: "601999451419",
        appId: "1:601999451419:web:f0782a8437b493eb8f5fbe"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let activeChatRoom = null;
    let replyData = null;

    // --- 2. ระบบสมาชิก (Auth) ---
    function handleAuth() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        if(!email || !pass) return;

        auth.signInWithEmailAndPassword(email, pass).catch(err => {
            if (err.code === 'auth/user-not-found') return auth.createUserWithEmailAndPassword(email, pass);
            document.getElementById('auth-error').innerText = err.message;
        });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            const shortId = user.uid.substring(0, 6).toUpperCase();
            document.getElementById('my-id-display').innerText = "ID: " + shortId;
            
            db.ref('users/' + user.uid).set({
                id: shortId,
                name: user.email.split('@')[0],
                online: true
            });
            loadFriends();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    // --- 3. ระบบแชทส่วนตัว (Private Chat) ---
    function loadFriends() {
        db.ref('users').on('value', snapshot => {
            const list = document.getElementById('friend-list');
            list.innerHTML = '';
            snapshot.forEach(child => {
                if (child.key !== currentUser.uid) {
                    const div = document.createElement('div');
                    div.className = 'friend-card';
                    div.innerHTML = `<i class="fa fa-user-circle"></i><div style="font-size:10px">${child.val().id}</div>`;
                    div.onclick = () => openChat(child.key, child.val().id);
                    list.appendChild(div);
                }
            });
        });
    }

    function openChat(friendUid, friendId) {
        activeChatRoom = [currentUser.uid, friendUid].sort().join('_');
        document.getElementById('target-name').innerText = "Chat: " + friendId;
        document.getElementById('chat-container').innerHTML = '';

        db.ref('messages/' + activeChatRoom).off();
        db.ref('messages/' + activeChatRoom).on('child_added', snap => {
            renderMsg(snap.val());
        });
    }

    function sendMsg() {
        if (!activeChatRoom) return alert("กรุณาเลือกเพื่อนเพื่อแชท");
        const input = document.getElementById('mainInput');
        const text = input.value.trim();
        if (!text) return;

        db.ref('messages/' + activeChatRoom).push({
            sender: currentUser.uid,
            text: text,
            replyTo: replyData,
            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        input.value = "";
        cancelReply();
    }

    function renderMsg(data) {
        const side = data.sender === currentUser.uid ? 'me' : 'you';
        const div = document.createElement('div');
        div.className = `msg ${side}`;
        
        let rHtml = data.replyTo ? `<div style="font-size:10px; opacity:0.6; border-left:2px solid gray; padding-left:5px; margin-bottom:5px;">↩ ${data.replyTo}</div>` : '';
        
        div.innerHTML = `${rHtml}<div>${data.text}</div><div style="font-size:9px; opacity:0.5; text-align:right; margin-top:4px;">${data.time}</div>`;
        
        div.onclick = () => {
            replyData = data.text;
            document.getElementById('replyBar').style.display = 'block';
            document.getElementById('replyText').innerText = "ตอบกลับ: " + data.text;
        };

        const container = document.getElementById('chat-container');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function cancelReply() { replyData = null; document.getElementById('replyBar').style.display = 'none'; }
    function openCall(t) { document.getElementById('callType').innerText = t; document.getElementById('callOverlay').style.display = 'flex'; }
    function closeCall() { document.getElementById('callOverlay').style.display = 'none'; }
</script>
</body>
</html>
